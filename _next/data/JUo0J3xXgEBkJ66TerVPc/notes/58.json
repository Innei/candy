{"pageProps":{"title":"记意外重新部署Typecho","nid":58,"created":"2020-09-05T06:31:15.626Z","modified":"2020-09-05T05:07:55.000Z","content":"---\ndate: 2019-02-16T09:22:00.000Z\nupdated: 2020-09-04T21:40:21.435Z\ntitle: 记意外重新部署Typecho\nslug: 记意外重新部署Typecho\nid: 10\npermalink: notes/10\ntype: Note\n\n---\n\n<!-- index-menu -->\r\n### 前言\r\n\r\n在使用lamp脚本部署discuz失败后以至于apache无法启动。原因未知。\r\n\r\n![](https://i.loli.net/2019/04/23/5cbedac2e2028.png)\r\n\r\n然后决定删除机器,重新部署。不慎将博客所搭建的那台删除了。我当时内心#%#￥#。\r\n\r\n对，就是你现在访问的这个博客。\r\n\r\n几分钟后，我决定重建。幸好数据库有备份。应该还有救。\r\n\r\n### 准备\r\n\r\n#### 部署lnmp环境\r\n\r\n这里推荐使用 <https://lnmp.org/install.html>\r\n\r\n（可以先进入screen再进行如下操作）\r\n\r\n```bash\r\nwget http://soft.vpser.net/lnmp/lnmp1.5.tar.gz -cO lnmp1.5.tar.gz && tar zxf lnmp1.5.tar.gz && cd lnmp1.5 && ./install.sh lnmp\r\n```\r\n\r\n建议使用前先将云主机性能拉到最高，否则时间需求过高。\r\n\r\n这里我选用高版本php导致安装失败两次，心塞。\r\n\r\n终于失败两次后胜利部署。\r\n\r\n![](https://i.loli.net/2019/04/23/5cbedaf29d707.png)\r\n\r\n#### 建立虚拟主机\r\n\r\n> 小插曲\r\n>\r\n> 在连接mysql时，出现了错误，如下。\r\n>\r\n> ![](https://i.loli.net/2019/04/23/5cbedb0c00952.png)\r\n>\r\n> 日志如下：\r\n>\r\n> ![](https://i.loli.net/2019/04/23/5cbedb1d18557.png)\r\n>\r\n> 原因是缓冲区过大，内存不足所导致。\r\n>\r\n> 方法一： 增加swap\r\n>\r\n> 方法二： 减少缓冲区大小\r\n>\r\n>  `nano /etc/my.cnf` 找到`innodb_buffer_pool_size` 调整合适的大小。 \r\n\r\n\r\n\r\n建立虚拟主机使用 `lnmp vhost add`\r\n\r\n![](https://i.loli.net/2019/04/23/5cbedb312b6ff.png)\r\n\r\n`cd /home/wwwroot/innei.ml`\r\n\r\n然后clone typecho到这里\r\n\r\n`git clone https://github.com/typecho/typecho.git .`\r\n\r\n设置好域名后，进入你的网站 比如（https://innei.ml）\r\n\r\n![](https://i.loli.net/2019/04/23/5cbedb47d1673.png)\r\n\r\n然后按照步骤安装。\r\n\r\n### 备份恢复\r\n\r\n进入phpmyadmin修改user表。允许用户远程登录\r\n\r\n> 插曲\r\n>\r\n> ![](https://i.loli.net/2019/04/23/5cbedb5ad0889.png)\r\n>\r\n> 打开了gcp的防火墙。却没想到系统的防火墙这么猛。\r\n>\r\n> ![](https://i.loli.net/2019/04/23/5cbedb6a98979.png)\r\n>\r\n> 使用 `iptables -L -n --line-numbers`标号\r\n>\r\n> 使用`iptables -D INPUT 6`删除\r\n>\r\n> 使用`iptables -A INPUT -p tcp --dport 3306 -j ACCEPT`添加允许。\r\n\r\n\r\n\r\n![image-20190216170450486](https://ws2.sinaimg.cn/large/006tKfTcly1g08diws284j31cu0u0dlc.jpg)\r\n\r\n胜利还原。\r\n\r\n#### 签发证书启用https\r\n\r\n拿到cf的api,export两条记录\r\n\r\n下载acem.sh\r\n\r\n```\r\ncurl  https://get.acme.sh | sh\r\n.acme.sh/acme.sh --issue --dns dns_cf -d innei.ml -d *.innei.ml\r\n```\r\n\r\n然后使用`lnmp ssl add`添加证书\r\n\r\n![image-20190216171917322](https://ws4.sinaimg.cn/large/006tKfTcly1g08dxtwymcj31040qggr5.jpg)\r\n\r\n#### 后记\r\n\r\n再经历2次安装lnmp失败。\r\n\r\n一次DB缓冲区溢出。\r\n\r\niptables防火墙DROP\r\n\r\n一次删库。\r\n\r\n虽然我花了一个下午时间来还原，遇到了不少麻烦，还有很多热心的网友，我学习到了很多。再次感谢你们！\r\n\r\n\r\n\r\n**教训：数据无价，谨慎操作**","mood":"","weather":"","hasNext":true,"hasPrev":true},"__N_SSG":true}